<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Invoice Generator - Virtual Life</title>
    <!-- Favicon -->
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üå©Ô∏è</text></svg>">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- FontAwesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Share+Tech+Mono&display=swap"
        rel="stylesheet">

    <style>
        :root {
            --dark-purple: #0a0015;
            --mid-purple: #1a0033;
            --neon-blue: #00d4ff;
            --ai-primary: #ff00ff;
            --ai-secondary: #00f5ff;
            --ai-accent: #ff6b00;
            --light-gray: #e0e0e0;
        }

        body {
            background-color: var(--dark-purple);
            color: var(--light-gray);
            font-family: 'Share Tech Mono', monospace;
        }

        .generator-container {
            background: linear-gradient(135deg, rgba(10, 0, 21, 0.95), rgba(26, 0, 51, 0.95));
            border: 1px solid var(--neon-blue);
            border-radius: 15px;
            box-shadow: 0 0 30px rgba(0, 212, 255, 0.2);
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
        }

        .generator-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                repeating-linear-gradient(90deg,
                    transparent,
                    transparent 2px,
                    rgba(0, 245, 255, 0.03) 2px,
                    rgba(0, 245, 255, 0.03) 4px),
                repeating-linear-gradient(0deg,
                    transparent,
                    transparent 2px,
                    rgba(189, 0, 255, 0.03) 2px,
                    rgba(189, 0, 255, 0.03) 4px);
            pointer-events: none;
        }

        .form-control,
        .form-select {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(0, 212, 255, 0.3);
            color: var(--light-gray);
            border-radius: 8px;
        }

        .form-control:focus,
        .form-select:focus {
            background: rgba(0, 0, 0, 0.4);
            border-color: var(--neon-blue);
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.3);
            color: var(--light-gray);
        }

        .form-label {
            color: var(--neon-blue);
            font-family: 'Orbitron', sans-serif;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.9rem;
        }

        .section-header {
            background: linear-gradient(135deg, var(--ai-primary), var(--ai-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-family: 'Orbitron', sans-serif;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 1.5rem;
            position: relative;
            z-index: 2;
        }

        .service-item {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(0, 212, 255, 0.2);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            position: relative;
            z-index: 2;
        }

        .btn-add-service {
            background: linear-gradient(135deg, var(--ai-accent), rgba(255, 107, 0, 0.8));
            border: none;
            color: white;
            border-radius: 25px;
            padding: 0.5rem 1.5rem;
            font-family: 'Orbitron', sans-serif;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
        }

        .btn-add-service:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(255, 107, 0, 0.4);
        }

        .btn-remove-service {
            background: rgba(255, 0, 0, 0.2);
            border: 1px solid rgba(255, 0, 0, 0.5);
            color: #ff4444;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .btn-remove-service:hover {
            background: rgba(255, 0, 0, 0.3);
            transform: scale(1.1);
        }

        .btn-generate {
            background: linear-gradient(135deg, var(--ai-primary), var(--ai-secondary));
            border: none;
            color: white;
            padding: 1rem 3rem;
            border-radius: 25px;
            font-family: 'Orbitron', sans-serif;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            box-shadow: 0 5px 30px rgba(255, 0, 255, 0.3);
            position: relative;
            z-index: 2;
        }

        .btn-generate:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 40px rgba(255, 0, 255, 0.5);
        }

        .total-preview {
            background: linear-gradient(135deg, rgba(255, 0, 255, 0.1), rgba(255, 107, 0, 0.1));
            border: 1px solid var(--ai-primary);
            border-radius: 10px;
            padding: 1.5rem;
            position: relative;
            z-index: 2;
        }

        .total-amount {
            font-family: 'Orbitron', sans-serif;
            font-size: 2rem;
            font-weight: 700;
            color: var(--ai-primary);
            text-shadow: 0 0 15px var(--ai-primary);
        }

        .client-card {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            z-index: 2;
        }

        .client-card:hover {
            border-color: var(--ai-primary);
            background: rgba(255, 0, 255, 0.1);
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(255, 0, 255, 0.3);
        }

        .client-card.selected {
            border: 2px solid var(--ai-primary);
            background: linear-gradient(135deg, rgba(255, 0, 255, 0.2), rgba(255, 107, 0, 0.1));
            box-shadow: 0 0 20px rgba(255, 0, 255, 0.4);
        }

        .client-card h6 {
            color: var(--neon-blue);
            font-family: 'Orbitron', sans-serif;
            margin-bottom: 0.5rem;
        }

        .client-card p {
            color: var(--light-gray);
            margin-bottom: 0.25rem;
            font-size: 0.9rem;
        }

        .client-card .client-rate {
            color: var(--ai-accent);
            font-weight: bold;
        }

        .invoice-info-card {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 10px;
            padding: 1.5rem;
            position: relative;
            z-index: 2;
        }

        .invoice-info-card h5 {
            color: var(--neon-blue);
            font-family: 'Orbitron', sans-serif;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 1rem;
            text-shadow: 0 0 10px var(--neon-blue);
        }

        #invoicePreviewContent {
            background: transparent;
            border-radius: 10px;
            overflow: hidden;
        }

        #invoicePreviewContent .print-button {
            display: none !important;
        }

        .modal-body {
            background: transparent !important;
        }

        #pdf-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 0, 21, 0.8);
            backdrop-filter: blur(5px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: var(--neon-blue);
            font-family: 'Orbitron', sans-serif;
            font-size: 1.5rem;
            text-shadow: 0 0 10px var(--neon-blue);
        }
    </style>
</head>

<body>
    <div id="pdf-loader">
        <i class="fas fa-cog fa-spin me-3"></i> Generating PDF...
    </div>

    <div class="container py-5">
        <div class="generator-container p-4 p-md-5">
            <!-- Header -->
            <div class="text-center mb-5">
                <div class="d-flex align-items-center justify-content-center mb-3">
                    <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDgwIDEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZGVmcz48bGluZWFyR3JhZGllbnQgaWQ9ImdyYWQiIHgxPSIwJSIgeTE9IjAlIiB4Mj0iMTAwJSIgeTI9IjEwMCUiPjxzdG9wIG9mZnNldD0iMCUiIHN0eWxlPSJzdG9wLWNvbG9yOiNmZjAwZmY7c3RvcC1vcGFjaXR5OjEiIC8+PHN0b3Agb2Zmc2V0PSIxMDAlIiBzdHlsZT0ic3RvcC1jb2xvcjojMDBmNWZmO3N0b3Atb3BhY2l0eToxIiAvPjwvbGluZWFyR3JhZGllbnQ+PC9kZWZzPjxwYXRoIGQ9Ik00MCAwIEwxNSA1MCBMMzUgNTAgTDIwIDEwMCBMNzAgNDAgTDUwIDQwIFoiIGZpbGw9InVybCgjZ3JhZCkiLz48L3N2Zz4="
                        alt="Virtual Life Logo" height="60" class="me-3">
                    <h1 class="section-header mb-0">Invoice Generator</h1>
                </div>
                <p>
                    Create professional invoices with AI-powered precision
                </p>
            </div>

            <form id="invoiceForm">
                <!-- Client Management -->
                <div class="row mb-5">
                    <div class="col-12">
                        <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
                            <h3 class="section-header mb-0 me-3">
                                <i class="fas fa-users me-2"></i>Client Management
                            </h3>
                            <div class="d-flex flex-wrap mt-2 mt-md-0">
                                <button type="button" class="btn btn-sm me-2 mb-1"
                                    style="background: rgba(0, 212, 255, 0.2); border: 1px solid var(--neon-blue); color: var(--neon-blue);"
                                    onclick="exportClientsData()" title="Export client data as backup file">
                                    <i class="fas fa-download me-1"></i>Export
                                </button>
                                <button type="button" class="btn btn-sm me-2 mb-1"
                                    style="background: rgba(255, 107, 0, 0.2); border: 1px solid var(--ai-accent); color: var(--ai-accent);"
                                    onclick="importClientsData()" title="Import client data from backup file">
                                    <i class="fas fa-upload me-1"></i>Import
                                </button>
                                <button type="button" class="btn btn-sm me-3 mb-1"
                                    style="background: rgba(255, 0, 255, 0.2); border: 1px solid var(--ai-primary); color: var(--ai-primary);"
                                    onclick="restoreFromAutoBackup()" title="Restore from automatic backup">
                                    <i class="fas fa-history me-1"></i>Restore
                                </button>
                                <button type="button" class="btn btn-add-service mb-1" onclick="showAddClientModal()">
                                    <i class="fas fa-plus me-2"></i>Add New Client
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Client List -->
                    <div class="col-12 mb-4">
                        <div class="invoice-info-card">
                            <h5><i class="fas fa-list me-2"></i>Select Client</h5>
                            <div id="clientList" class="row">
                                <!-- Client cards will be populated here -->
                            </div>
                        </div>
                    </div>

                    <!-- Selected Client Details -->
                    <div id="selectedClientDetails" style="display: none;">
                        <div class="col-md-12 mb-3">
                            <div class="invoice-info-card" style="border: 2px solid var(--ai-primary);">
                                <h5><i class="fas fa-check-circle me-2"></i>Selected Client</h5>
                                <div class="row">
                                    <div class="col-md-8">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <p><strong>Company:</strong> <span id="displayCompany">-</span></p>
                                                <p><strong>Contact:</strong> <span id="displayName">-</span></p>
                                                <p><strong>Email:</strong> <span id="displayEmail">-</span></p>
                                            </div>
                                            <div class="col-md-6">
                                                <p><strong>Phone:</strong> <span id="displayPhone">-</span></p>
                                                <p><strong>Address:</strong> <span id="displayAddress">-</span></p>
                                                <p><strong>Default Rate:</strong> R<span id="displayRate">0.00</span>/hr
                                                </p>
                                                <p><strong>Default VAT:</strong> <span id="displayVatRate">15</span>%
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4 text-end">
                                        <button type="button" class="btn btn-sm mb-2"
                                            style="background: rgba(255, 107, 0, 0.2); border: 1px solid var(--ai-accent); color: var(--ai-accent);"
                                            onclick="editSelectedClient()">
                                            <i class="fas fa-edit me-1"></i>Edit Client
                                        </button><br>
                                        <button type="button" class="btn btn-sm"
                                            style="background: rgba(255, 0, 0, 0.2); border: 1px solid rgba(255, 0, 0, 0.5); color: #ff4444;"
                                            onclick="clearClientSelection()">
                                            <i class="fas fa-times me-1"></i>Clear Selection
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Invoice Details -->
                <div class="row mb-5">
                    <div class="col-12">
                        <h3 class="section-header">
                            <i class="fas fa-file-invoice me-2"></i>Invoice Details
                        </h3>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="invoiceNumber" class="form-label">Invoice Number</label>
                        <input type="text" class="form-control" id="invoiceNumber" readonly>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="invoiceDate" class="form-label">Invoice Date</label>
                        <input type="date" class="form-control" id="invoiceDate" required>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="dueDate" class="form-label">Due Date</label>
                        <input type="date" class="form-control" id="dueDate" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="taxRate" class="form-label">VAT Rate (%)</label>
                        <input type="number" class="form-control" id="taxRate" value="15" step="0.1" min="0" max="100">
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="periodStart" class="form-label">Period Start</label>
                        <input type="date" class="form-control" id="periodStart" required>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="periodEnd" class="form-label">Period End</label>
                        <input type="date" class="form-control" id="periodEnd" required>
                    </div>
                </div>

                <!-- Company Details -->
                <div class="row mb-5">
                    <div class="col-12">
                        <h3 class="section-header">
                            <i class="fas fa-building me-2"></i>Your Company Details
                        </h3>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="companyName" class="form-label">Company Name</label>
                        <input type="text" class="form-control" id="companyName"
                            value="Virtual Life Solutions PTY (Ltd)" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="companyWebsite" class="form-label">Website</label>
                        <input type="text" class="form-control" id="companyWebsite" value="www.virtual-life.co.za">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="companyReg" class="form-label">Registration Number</label>
                        <input type="text" class="form-control" id="companyReg" value="2015/123337/07">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="companyVat" class="form-label">VAT Number</label>
                        <input type="text" class="form-control" id="companyVat" value="">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="companyEmail" class="form-label">Email</label>
                        <input type="email" class="form-control" id="companyEmail" value="office@virtual-life.co.za">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="companyPhone" class="form-label">Phone</label>
                        <input type="tel" class="form-control" id="companyPhone" value="074 348 8311">
                    </div>
                    <div class="col-12 mb-3">
                        <label for="companyAddress" class="form-label">Address</label>
                        <textarea class="form-control" id="companyAddress" rows="3">75 Country Walk, Mooikloof Ridge Estate
Mooikloof, Pretoria</textarea>
                    </div>
                </div>

                <!-- Services -->
                <div class="row mb-5">
                    <div class="col-12">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h3 class="section-header mb-0">
                                <i class="fas fa-cogs me-2"></i>Services
                            </h3>
                            <button type="button" class="btn btn-add-service" onclick="addService()">
                                <i class="fas fa-plus me-2"></i>Add Service
                            </button>
                        </div>
                    </div>
                    <div class="col-12">
                        <div id="servicesContainer">
                            <!-- Services will be added here dynamically -->
                        </div>
                    </div>
                </div>

                <!-- Total Preview -->
                <div class="row mb-4 justify-content-end">
                    <div class="col-md-6 col-lg-5">
                        <div class="total-preview">
                            <div class="d-flex justify-content-between mb-2">
                                <span>Subtotal:</span>
                                <span id="subtotalPreview">R0.00</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>VAT (<span id="vatPercentPreview">15</span>%):</span>
                                <span id="taxPreview">R0.00</span>
                            </div>
                            <hr style="border-color: var(--ai-primary);">
                            <div class="d-flex justify-content-between">
                                <span><strong>Total:</strong></span>
                                <span class="total-amount" id="totalPreview">R0.00</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Generate Button -->
                <div class="text-center">
                    <button type="submit" class="btn btn-generate">
                        <i class="fas fa-eye me-2"></i>Preview Invoice
                    </button>
                </div>
            </form>
        </div>
    </div>
    <!-- Add/Edit Client Modal -->
    <div class="modal fade" id="clientModal" tabindex="-1" aria-labelledby="clientModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content"
                style="background: linear-gradient(135deg, rgba(10, 0, 21, 0.95), rgba(26, 0, 51, 0.95)); border: 1px solid var(--neon-blue);">
                <div class="modal-header" style="border-bottom: 1px solid rgba(0, 212, 255, 0.3);">
                    <h5 class="modal-title" id="clientModalLabel"
                        style="color: var(--neon-blue); font-family: 'Orbitron', sans-serif;">
                        <i class="fas fa-user-plus me-2"></i>Add New Client
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"
                        style="filter: invert(1);"></button>
                </div>
                <div class="modal-body">
                    <form id="clientForm">
                        <input type="hidden" id="editClientId">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="modalClientName" class="form-label">Contact Name (Optional)</label>
                                <input type="text" class="form-control" id="modalClientName">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="modalClientCompany" class="form-label">Company Name</label>
                                <input type="text" class="form-control" id="modalClientCompany" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="modalClientVat" class="form-label">VAT Number (Optional)</label>
                                <input type="text" class="form-control" id="modalClientVat" placeholder="4123456789">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="modalClientReg" class="form-label">Registration Number (Optional)</label>
                                <input type="text" class="form-control" id="modalClientReg"
                                    placeholder="2021/123456/07">
                            </div>
                            <div class="col-md-12 mb-3">
                                <label for="modalClientAddress" class="form-label">Address</label>
                                <textarea class="form-control" id="modalClientAddress" rows="2"
                                    placeholder="Private Bag 127&#10;Bryanston&#10;2021" required></textarea>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="modalClientEmail" class="form-label">Email (Optional)</label>
                                <input type="email" class="form-control" id="modalClientEmail">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="modalClientPhone" class="form-label">Phone (Optional)</label>
                                <input type="tel" class="form-control" id="modalClientPhone">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="modalClientRate" class="form-label">Default Hourly Rate (R)</label>
                                <input type="number" class="form-control" id="modalClientRate" step="0.01" min="0"
                                    required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="modalClientVatRate" class="form-label">Default VAT Rate (%)</label>
                                <input type="number" class="form-control" id="modalClientVatRate" step="0.1" min="0"
                                    max="100" value="15" required>
                                <small class="text-muted">0 for VAT exempt clients</small>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="modalClientCode" class="form-label">Client Code (2-3 letters)</label>
                                <input type="text" class="form-control" id="modalClientCode" maxlength="3"
                                    style="text-transform: uppercase;" required>
                                <small class="text-muted">Used for invoice numbering (e.g., BH)</small>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="modalClientInvoiceNumber" class="form-label">Current Invoice Number</label>
                                <input type="number" class="form-control" id="modalClientInvoiceNumber" min="0" step="1"
                                    value="0">
                                <small class="text-muted">Next invoice will be this number + 1</small>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer" style="border-top: 1px solid rgba(0, 212, 255, 0.3);">
                    <button type="button" class="btn"
                        style="background: rgba(255, 0, 0, 0.2); border: 1px solid rgba(255, 0, 0, 0.5); color: #ff4444;"
                        data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-generate" onclick="saveClient()">
                        <i class="fas fa-save me-2"></i>Save Client
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Invoice Preview Modal -->
    <div class="modal fade" id="invoicePreviewModal" tabindex="-1" aria-labelledby="invoicePreviewModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content"
                style="background: linear-gradient(135deg, rgba(10, 0, 21, 0.95), rgba(26, 0, 51, 0.95)); border: 1px solid var(--neon-blue);">
                <div class="modal-header" style="border-bottom: 1px solid rgba(0, 212, 255, 0.3);">
                    <h5 class="modal-title" id="invoicePreviewModalLabel"
                        style="color: var(--neon-blue); font-family: 'Orbitron', sans-serif;">
                        <i class="fas fa-eye me-2"></i>Invoice Preview
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"
                        style="filter: invert(1);"></button>
                </div>
                <div class="modal-body p-0">
                    <div id="invoicePreviewContent" style="max-height: 80vh; overflow-y: auto;">
                        <!-- Invoice preview will be loaded here -->
                    </div>
                </div>
                <div class="modal-footer" style="border-top: 1px solid rgba(0, 212, 255, 0.3);">
                    <button type="button" class="btn"
                        style="background: rgba(255, 0, 0, 0.2); border: 1px solid rgba(255, 0, 0, 0.5); color: #ff4444;"
                        data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Close
                    </button>
                    <button type="button" class="btn btn-generate me-2" onclick="generatePDFPrint()">
                        <i class="fas fa-print me-2"></i>Print to PDF
                    </button>
                    <button type="button" class="btn btn-generate" onclick="generatePDF()">
                        <i class="fas fa-file-pdf me-2"></i>Download PDF
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        let serviceCount = 0;
        let clients = [];
        let currentClient = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function () {
            const today = new Date();
            const dueDate = new Date(today);
            dueDate.setDate(today.getDate() + 30);

            document.getElementById('invoiceDate').valueAsDate = today;
            document.getElementById('dueDate').valueAsDate = dueDate;

            document.getElementById('invoiceDate').addEventListener('change', updateDueDateFromInvoiceDate);

            loadClients();
            addService();
        });

        // Date Management
        function updateDueDateFromInvoiceDate() {
            const invoiceDateInput = document.getElementById('invoiceDate');
            if (invoiceDateInput.value) {
                const invoiceDate = new Date(invoiceDateInput.value);
                const dueDate = new Date(invoiceDate);
                dueDate.setDate(invoiceDate.getDate() + 30);
                document.getElementById('dueDate').valueAsDate = dueDate;
            }
        }

        function setInvoicePeriod() {
            if (!currentClient) return;
            const clientPeriods = JSON.parse(localStorage.getItem('clientPeriods') || '{}');
            const clientPeriod = clientPeriods[currentClient.code];

            if (clientPeriod && clientPeriod.lastPeriodEnd) {
                const lastEndDate = new Date(clientPeriod.lastPeriodEnd);
                const nextStartDate = new Date(lastEndDate);
                nextStartDate.setDate(lastEndDate.getDate() + 1);
                const nextEndDate = new Date(nextStartDate);
                nextEndDate.setMonth(nextStartDate.getMonth() + 1);
                nextEndDate.setDate(nextEndDate.getDate() - 1);

                document.getElementById('periodStart').valueAsDate = nextStartDate;
                document.getElementById('periodEnd').valueAsDate = nextEndDate;
            } else {
                const today = new Date();
                const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                const endOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                document.getElementById('periodStart').valueAsDate = startOfMonth;
                document.getElementById('periodEnd').valueAsDate = endOfMonth;
            }
        }

        function saveInvoicePeriod() {
            if (!currentClient) return;
            const periodEnd = document.getElementById('periodEnd').value;
            if (!periodEnd) return;
            const clientPeriods = JSON.parse(localStorage.getItem('clientPeriods') || '{}');
            if (!clientPeriods[currentClient.code]) clientPeriods[currentClient.code] = {};
            clientPeriods[currentClient.code].lastPeriodEnd = periodEnd;
            localStorage.setItem('clientPeriods', JSON.stringify(clientPeriods));
        }

        // Client Management
        function loadClients() {
            const savedClients = localStorage.getItem('invoiceClients');
            if (savedClients) {
                clients = JSON.parse(savedClients);
            } else {
                clients = [{
                    id: 'BH001', name: 'Britehouse Contact', company: 'Britehouse mobility (PTY) Ltd',
                    address: 'Private Bag 127\nBryanston\n2021',
                    email: 'contact@britehouse.co.za', phone: '+27 21 123 4567',
                    rate: 412.80, code: 'BH', vatNumber: '4130205356', regNumber: '1997/014442/07', vatRate: 0
                }];
                saveClientsToStorage();
            }
            populateClientList();
        }

        function saveClientsToStorage() {
            localStorage.setItem('invoiceClients', JSON.stringify(clients));
            autoBackupClients();
        }

        function exportClientsData() {
            const allData = {
                clients: clients,
                invoiceNumbers: JSON.parse(localStorage.getItem('invoiceNumbers') || '{}'),
                clientPeriods: JSON.parse(localStorage.getItem('clientPeriods') || '{}'),
                exportDate: new Date().toISOString(), version: '1.0'
            };
            const dataStr = JSON.stringify(allData, null, 2);
            const link = document.createElement('a');
            link.href = URL.createObjectURL(new Blob([dataStr], { type: 'application/json' }));
            link.download = `invoice-clients-backup-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            alert('Client data exported successfully!');
        }

        function importClientsData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = e => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = function (event) {
                    try {
                        const importedData = JSON.parse(event.target.result);
                        if (!importedData.clients || !Array.isArray(importedData.clients)) throw new Error('Invalid file format');
                        if (confirm(`Import ${importedData.clients.length} clients? This will replace current data.`)) {
                            clients = importedData.clients;
                            if (importedData.invoiceNumbers) localStorage.setItem('invoiceNumbers', JSON.stringify(importedData.invoiceNumbers));
                            if (importedData.clientPeriods) localStorage.setItem('clientPeriods', JSON.stringify(importedData.clientPeriods));
                            saveClientsToStorage();
                            populateClientList();
                            alert(`Successfully imported ${clients.length} clients!`);
                        }
                    } catch (error) {
                        alert('Error importing file: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function autoBackupClients() {
            if (clients.length > 0) {
                const backupData = {
                    clients: clients,
                    invoiceNumbers: JSON.parse(localStorage.getItem('invoiceNumbers') || '{}'),
                    clientPeriods: JSON.parse(localStorage.getItem('clientPeriods') || '{}'),
                    autoBackup: true, timestamp: new Date().toISOString()
                };
                localStorage.setItem('invoiceClientsAutoBackup', JSON.stringify(backupData));
            }
        }

        function restoreFromAutoBackup() {
            const autoBackup = localStorage.getItem('invoiceClientsAutoBackup');
            if (!autoBackup) return alert('No auto-backup found.');
            try {
                const backupData = JSON.parse(autoBackup);
                const backupDate = new Date(backupData.timestamp).toLocaleString();
                if (confirm(`Restore from auto-backup created ${backupDate} with ${backupData.clients.length} clients?`)) {
                    clients = backupData.clients;
                    if (backupData.invoiceNumbers) localStorage.setItem('invoiceNumbers', JSON.stringify(backupData.invoiceNumbers));
                    if (backupData.clientPeriods) localStorage.setItem('clientPeriods', JSON.stringify(backupData.clientPeriods));
                    saveClientsToStorage();
                    populateClientList();
                    alert('Data restored successfully!');
                }
            } catch (error) {
                alert('Error restoring auto-backup: ' + error.message);
            }
        }

        function populateClientList() {
            const clientList = document.getElementById('clientList');
            clientList.innerHTML = '';
            if (clients.length === 0) {
                clientList.innerHTML = '<div class="col-12"><p class="text-center">No clients found. Add a new client to get started.</p></div>';
                return;
            }
            clients.forEach(client => {
                const clientCard = document.createElement('div');
                clientCard.className = 'col-md-6 col-lg-4 mb-3';
                clientCard.innerHTML = `
                  <div class="client-card h-100" onclick="selectClient('${client.id}')" id="client-card-${client.id}">
                    <h6><i class="fas fa-building me-2"></i> ${client.company} ${client.name ? `(${client.name})` : ''}</h6>
                    <p class="client-rate"><i class="fas fa-money-bill me-2"></i> R${parseFloat(client.rate).toFixed(2)}/hr</p>
                    <div class="mt-auto pt-2">
                      <button type="button" class="btn btn-sm me-2" style="background: rgba(0, 212, 255, 0.2); border: 1px solid var(--neon-blue); color: var(--neon-blue); font-size: 0.8rem;" onclick="event.stopPropagation(); editClient('${client.id}')"><i class="fas fa-edit me-1"></i>Edit</button>
                      <button type="button" class="btn btn-sm" style="background: rgba(255, 0, 0, 0.2); border: 1px solid rgba(255, 0, 0, 0.5); color: #ff4444; font-size: 0.8rem;" onclick="event.stopPropagation(); deleteClient('${client.id}')"><i class="fas fa-trash me-1"></i>Delete</button>
                    </div>
                  </div>`;
                clientList.appendChild(clientCard);
            });
        }

        function selectClient(clientId) {
            document.querySelectorAll('.client-card').forEach(c => c.classList.remove('selected'));
            document.getElementById(`client-card-${clientId}`).classList.add('selected');

            currentClient = clients.find(c => c.id === clientId);
            if (currentClient) {
                const { company, name, email, phone, address, rate, vatRate } = currentClient;
                document.getElementById('displayCompany').textContent = company;
                document.getElementById('displayName').textContent = name || '-';
                document.getElementById('displayEmail').textContent = email || '-';
                document.getElementById('displayPhone').textContent = phone || '-';
                document.getElementById('displayAddress').textContent = address.replace(/\n/g, ', ');
                document.getElementById('displayRate').textContent = parseFloat(rate).toFixed(2);
                document.getElementById('displayVatRate').textContent = vatRate ?? 15;
                document.getElementById('taxRate').value = vatRate ?? 15;
                document.getElementById('selectedClientDetails').style.display = 'block';

                document.querySelectorAll('.service-rate').forEach(input => input.value = parseFloat(rate).toFixed(2));
                generateInvoiceNumber();
                setInvoicePeriod();
                calculateTotal();
            }
        }

        function clearClientSelection() {
            document.querySelectorAll('.client-card').forEach(c => c.classList.remove('selected'));
            currentClient = null;
            document.getElementById('selectedClientDetails').style.display = 'none';
            document.getElementById('invoiceNumber').value = '';
        }

        function generateInvoiceNumber() {
            if (!currentClient) return;
            const existingInvoices = JSON.parse(localStorage.getItem('invoiceNumbers') || '{}');
            const clientKey = currentClient.code.toUpperCase();
            let nextNumber = (existingInvoices[clientKey] || 0) + 1;
            const invoiceNumber = `INV${clientKey}${String(nextNumber).padStart(6, '0')}`;
            document.getElementById('invoiceNumber').value = invoiceNumber;
        }

        function incrementInvoiceNumber() {
            if (!currentClient) return;
            const existingInvoices = JSON.parse(localStorage.getItem('invoiceNumbers') || '{}');
            const clientKey = currentClient.code.toUpperCase();
            let nextNumber = (existingInvoices[clientKey] || 0) + 1;
            existingInvoices[clientKey] = nextNumber;
            localStorage.setItem('invoiceNumbers', JSON.stringify(existingInvoices));
        }

        function showAddClientModal() {
            document.getElementById('clientModalLabel').innerHTML = '<i class="fas fa-user-plus me-2"></i>Add New Client';
            document.getElementById('clientForm').reset();
            document.getElementById('editClientId').value = '';
            document.getElementById('modalClientInvoiceNumber').value = 0;
            new bootstrap.Modal(document.getElementById('clientModal')).show();
        }

        function editClient(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (!client) return;

            document.getElementById('clientModalLabel').innerHTML = '<i class="fas fa-user-edit me-2"></i>Edit Client';
            document.getElementById('editClientId').value = client.id;
            document.getElementById('modalClientName').value = client.name || '';
            document.getElementById('modalClientCompany').value = client.company || '';
            document.getElementById('modalClientVat').value = client.vatNumber || '';
            document.getElementById('modalClientReg').value = client.regNumber || '';
            document.getElementById('modalClientAddress').value = client.address || '';
            document.getElementById('modalClientEmail').value = client.email || '';
            document.getElementById('modalClientPhone').value = client.phone || '';
            document.getElementById('modalClientRate').value = client.rate || 0;
            document.getElementById('modalClientVatRate').value = client.vatRate ?? 15;
            document.getElementById('modalClientCode').value = client.code || '';

            const existingInvoices = JSON.parse(localStorage.getItem('invoiceNumbers') || '{}');
            document.getElementById('modalClientInvoiceNumber').value = existingInvoices[client.code] || 0;

            new bootstrap.Modal(document.getElementById('clientModal')).show();
        }

        function editSelectedClient() {
            if (currentClient) editClient(currentClient.id);
        }

        function deleteClient(clientId) {
            if (confirm('Are you sure you want to delete this client?')) {
                clients = clients.filter(c => c.id !== clientId);
                if (currentClient && currentClient.id === clientId) clearClientSelection();
                saveClientsToStorage();
                populateClientList();
            }
        }

        function saveClient() {
            const form = document.getElementById('clientForm');
            if (!form.checkValidity()) return form.reportValidity();

            const clientCode = document.getElementById('modalClientCode').value.toUpperCase();
            const clientData = {
                name: document.getElementById('modalClientName').value,
                company: document.getElementById('modalClientCompany').value,
                address: document.getElementById('modalClientAddress').value,
                email: document.getElementById('modalClientEmail').value,
                phone: document.getElementById('modalClientPhone').value,
                rate: parseFloat(document.getElementById('modalClientRate').value),
                code: clientCode,
                vatNumber: document.getElementById('modalClientVat').value,
                regNumber: document.getElementById('modalClientReg').value,
                vatRate: parseFloat(document.getElementById('modalClientVatRate').value)
            };

            const editId = document.getElementById('editClientId').value;
            if (editId) {
                const index = clients.findIndex(c => c.id === editId);
                if (index !== -1) clients[index] = { ...clients[index], ...clientData };
            } else {
                clientData.id = clientData.code + String(Date.now()).slice(-3);
                clients.push(clientData);
            }

            const invoiceNumber = parseInt(document.getElementById('modalClientInvoiceNumber').value) || 0;
            const existingInvoices = JSON.parse(localStorage.getItem('invoiceNumbers') || '{}');
            existingInvoices[clientCode] = invoiceNumber;
            localStorage.setItem('invoiceNumbers', JSON.stringify(existingInvoices));

            saveClientsToStorage();
            populateClientList();
            if (editId && currentClient && currentClient.id === editId) selectClient(editId);
            bootstrap.Modal.getInstance(document.getElementById('clientModal')).hide();
        }

        document.getElementById('modalClientCode').addEventListener('input', e => e.target.value = e.target.value.toUpperCase());

        // Services & Calculation
        function addService() {
            serviceCount++;
            const servicesContainer = document.getElementById('servicesContainer');
            const defaultRate = currentClient ? currentClient.rate : 0;
            const serviceHtml = `
              <div class="service-item" id="service-${serviceCount}">
                <div class="row align-items-end">
                  <div class="col-md-5 mb-3"><label class="form-label">Description</label><input type="text" class="form-control service-description" value="Services rendered" required><textarea class="form-control mt-2 service-details" rows="2" placeholder="Additional details (optional)"></textarea></div>
                  <div class="col-md-2 mb-3"><label class="form-label">Hours</label><input type="number" class="form-control service-quantity" value="1" min="0" step="0.25" required></div>
                  <div class="col-md-2 mb-3"><label class="form-label">Rate (R/hr)</label><input type="number" class="form-control service-rate" value="${parseFloat(defaultRate).toFixed(2)}" min="0" step="0.01" required></div>
                  <div class="col-md-2 mb-3"><label class="form-label">Amount</label><input type="text" class="form-control service-amount" readonly value="R${parseFloat(defaultRate).toFixed(2)}"></div>
                  <div class="col-md-1 mb-3 text-end"><button type="button" class="btn btn-remove-service" onclick="removeService(${serviceCount})"><i class="fas fa-times"></i></button></div>
                </div>
              </div>`;
            servicesContainer.insertAdjacentHTML('beforeend', serviceHtml);
            document.querySelectorAll(`#service-${serviceCount} input`).forEach(input => input.addEventListener('input', calculateServiceAmount));
            calculateTotal();
        }

        function removeService(serviceId) {
            document.getElementById(`service-${serviceId}`).remove();
            calculateTotal();
        }

        function calculateServiceAmount(event) {
            const serviceItem = event.target.closest('.service-item');
            const quantity = parseFloat(serviceItem.querySelector('.service-quantity').value) || 0;
            const rate = parseFloat(serviceItem.querySelector('.service-rate').value) || 0;
            serviceItem.querySelector('.service-amount').value = `R${(quantity * rate).toFixed(2)}`;
            calculateTotal();
        }

        function calculateTotal() {
            let subtotal = 0;
            document.querySelectorAll('.service-item').forEach(item => {
                subtotal += (parseFloat(item.querySelector('.service-quantity').value) || 0) * (parseFloat(item.querySelector('.service-rate').value) || 0);
            });
            const taxRate = parseFloat(document.getElementById('taxRate').value) || 0;
            const tax = subtotal * (taxRate / 100);
            const total = subtotal + tax;
            document.getElementById('vatPercentPreview').textContent = taxRate;
            document.getElementById('subtotalPreview').textContent = `R${subtotal.toFixed(2)}`;
            document.getElementById('taxPreview').textContent = `R${tax.toFixed(2)}`;
            document.getElementById('totalPreview').textContent = `R${total.toFixed(2)}`;
        }
        document.getElementById('taxRate').addEventListener('input', calculateTotal);

        // Invoice Generation
        document.getElementById('invoiceForm').addEventListener('submit', function (e) {
            e.preventDefault();
            if (!currentClient) return alert('Please select a client first.');

            const formData = getFormData();
            generateInvoiceHTML(formData);

            saveInvoicePeriod();
            incrementInvoiceNumber();
        });

        function getFormData() {
            const services = [];
            document.querySelectorAll('.service-item').forEach(service => {
                const quantity = parseFloat(service.querySelector('.service-quantity').value) || 0;
                const rate = parseFloat(service.querySelector('.service-rate').value) || 0;
                if (quantity > 0) {
                    services.push({
                        description: service.querySelector('.service-description').value,
                        details: service.querySelector('.service-details').value,
                        quantity, rate,
                        amount: quantity * rate
                    });
                }
            });
            const subtotal = services.reduce((sum, s) => sum + s.amount, 0);
            const taxRate = parseFloat(document.getElementById('taxRate').value) || 0;
            const tax = subtotal * (taxRate / 100);

            return {
                client: currentClient,
                company: {
                    name: document.getElementById('companyName').value,
                    website: document.getElementById('companyWebsite').value,
                    reg: document.getElementById('companyReg').value,
                    vat: document.getElementById('companyVat').value,
                    email: document.getElementById('companyEmail').value,
                    phone: document.getElementById('companyPhone').value,
                    address: document.getElementById('companyAddress').value
                },
                invoice: {
                    number: document.getElementById('invoiceNumber').value,
                    date: document.getElementById('invoiceDate').value,
                    dueDate: document.getElementById('dueDate').value,
                    taxRate: taxRate,
                    periodStart: document.getElementById('periodStart').value,
                    periodEnd: document.getElementById('periodEnd').value
                },
                services: services,
                totals: { subtotal, tax, total: subtotal + tax }
            };
        }

        function generateInvoiceHTML(data) {
            // THE USER'S TEMPLATE IS STORED HERE
            const template = `
            <!DOCTYPE html>
            <html lang="en">
            <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Invoice - Virtual Life</title>
              <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
              <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
              <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
              <style>
                :root { --dark-purple: #0a0015; --mid-purple: #1a0033; --neon-blue: #00d4ff; --ai-primary: #ff00ff; --ai-secondary: #00f5ff; --ai-accent: #ff6b00; --light-gray: #e0e0e0; }
                body { background: var(--dark-purple); color: var(--light-gray); font-family: 'Share Tech Mono', monospace; }
                .invoice-container { background: linear-gradient(135deg, rgba(10, 0, 21, 0.95), rgba(26, 0, 51, 0.95)); border: 1px solid var(--neon-blue); box-shadow: 0 0 30px rgba(0, 212, 255, 0.2); backdrop-filter: blur(10px); position: relative; overflow: hidden; border-radius: 12px; }
                .invoice-container::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: repeating-linear-gradient(90deg, transparent, transparent 2px, rgba(0, 245, 255, 0.03) 2px, rgba(0, 245, 255, 0.03) 4px), repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(189, 0, 255, 0.03) 2px, rgba(189, 0, 255, 0.03) 4px); pointer-events: none; }
                .invoice-header { background: linear-gradient(135deg, var(--ai-primary), var(--ai-secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; text-shadow: 0 0 16px rgba(255, 0, 255, 0.45); position: relative; z-index: 2; font-family: 'Orbitron', sans-serif; font-size: 2rem;}
                .invoice-number { font-family: 'Share Tech Mono', monospace; color: #00ff66; font-size: 1.1rem; font-weight: bold; text-shadow: 0 0 10px #00ff66; background: rgba(0, 255, 102, 0.12); padding: 0.25rem 0.5rem; border-radius: 6px; border: 1px solid #00ff66; display: inline-block; margin: 0; }
                .company-logo { filter: drop-shadow(0 0 15px rgba(255, 0, 255, 0.6)); animation: pulse-glow 3s ease-in-out infinite; height: 100%; width: auto; max-width: 100%; object-fit: contain; }
                @keyframes pulse-glow { 0%, 100% { filter: drop-shadow(0 0 15px rgba(255, 0, 255, 0.6)); } 50% { filter: drop-shadow(0 0 25px rgba(255, 0, 255, 0.8)); } }
                .payment-terms h6 { color: var(--neon-blue); font-family: 'Orbitron', sans-serif; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.5rem; }
                .invoice-table { background: rgba(255, 255, 255, 0.95); border: 1px solid rgba(0, 212, 255, 0.3); border-radius: 10px; overflow: hidden; position: relative; z-index: 2; }
                .invoice-table th { background: linear-gradient(135deg, rgba(0, 212, 255, 0.2), rgba(255, 0, 255, 0.1)); color: #1a1a1a; font-family: 'Orbitron', sans-serif; text-transform: uppercase; letter-spacing: 1px; border-bottom: 2px solid var(--neon-blue); font-weight: 600; }
                .invoice-table td { color: #2a2a2a; background: rgba(255, 255, 255, 0.9); border-bottom: 1px solid rgba(0, 212, 255, 0.2); vertical-align: middle; font-weight: 500; }
                .invoice-table th, .invoice-table td { padding: 0.5rem 0.5rem !important; }
                .total-section { background: linear-gradient(135deg, rgba(255, 0, 255, 0.1), rgba(255, 107, 0, 0.1)); border: 1px solid var(--ai-primary); border-radius: 10px; position: relative; z-index: 2; color: var(--light-gray);}
                .total-amount { font-family: 'Orbitron', sans-serif; font-size: 1.4rem; font-weight: 700; color: var(--ai-primary); text-shadow: 0 0 15px var(--ai-primary); }
                .invoice-info-card { background: rgba(0, 0, 0, 0.4); border: 1px solid rgba(0, 212, 255, 0.3); border-radius: 10px; padding: 1rem; position: relative; z-index: 2; height: 100%;}
                .invoice-info-card h5 { color: var(--neon-blue); font-family: 'Orbitron', sans-serif; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 1rem; text-shadow: 0 0 10px var(--neon-blue); }
                .invoice-info-card p { color: var(--light-gray); margin-bottom: 0.5rem; }
                .payment-terms { background: rgba(0, 212, 255, 0.1); border-left: 4px solid var(--neon-blue); padding: 0.75rem; border-radius: 0 10px 10px 0; position: relative; z-index: 2; height: 100%;}
                /* Preserve styling on print; only remove margins */
                @media print {
                  @page { size: A4; margin: 0 !important; }
                  body { margin: 0 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                }
              </style>
            </head>
            <body>
              <div class="container py-3">
                <div class="invoice-container p-3">
                  <div class="row mb-3 align-items-stretch">
                    <div class="col-12">
                      <div class="text-center text-md-start">
                        <h1 class="invoice-header mb-0">INVOICE</h1>
                      </div>
                    </div>
                  </div>
                  <div class="row mb-3 align-items-center">
                    <div class="col-md-4 d-flex justify-content-center justify-content-md-start"><img src="images/vlLogo.png" alt="Virtual Life Logo" class="company-logo"></div>
                    <div class="col-md-8 d-flex justify-content-center justify-content-md-end mt-3 mt-md-0"><div class="invoice-info-card text-end" style="width: 100%; max-width: 450px;"><p><strong>[COMPANY_NAME]</strong></p><p>[COMPANY_ADDRESS]</p><p>Registration: [COMPANY_REG]</p><p>Website: [COMPANY_WEBSITE]</p><p>Email: [COMPANY_EMAIL]</p><p>Phone: [COMPANY_PHONE]</p></div></div>
                  </div>
                  <div class="row mb-3">
                    <div class="col-md-6 mb-3 mb-md-0"><div class="invoice-info-card"><h5><i class="fas fa-user me-2"></i>Bill To</h5><p><strong>[CLIENT_COMPANY]</strong></p><p>[CLIENT_NAME]</p><p>[CLIENT_ADDRESS]</p><p>VAT: [CLIENT_VAT]</p><p>Reg: [CLIENT_REG]</p><p>Email: [CLIENT_EMAIL]</p><p>Phone: [CLIENT_PHONE]</p></div></div>
                    <div class="col-md-6">
                      <div class="row">
                        <div class="col-12 mb-3"><div class="invoice-info-card"><h5><i class="fas fa-hashtag me-2"></i>Invoice Number</h5><p class="invoice-number mb-0">#VL-2025-001</p></div></div>
                        <div class="col-12"><div class="invoice-info-card"><h5><i class="fas fa-calendar me-2"></i>Invoice Date</h5><p>[INVOICE_DATE]</p></div></div>
                      </div>
                    </div>
                  </div>
                  <!-- Period and Due Date row removed per request -->
                  <div class="table-responsive mb-3">
                    <table class="table invoice-table">
                      <thead><tr><th>Period</th><th class="text-center">Hours</th><th>Work Description</th><th class="text-center">Unit Price</th><th class="text-end">Total</th></tr></thead>
                      <tbody><!-- Services will be inserted here by JavaScript --></tbody>
                    </table>
                  </div>
                  <div class="row">
                    <div class="col-md-8 mb-3 mb-md-0">
                      <div class="payment-terms">
                        <div class="row">
                          <div class="col-md-6">
                            <h6>Payment Terms:</h6>
                            <ul class="mb-3 ps-4">
                              <li>Invoice payable within 30 days</li>
                              <li>If payment is not made as specified above, all services will be suspended</li>
                            </ul>
                          </div>
                          <div class="col-md-6">
                            <h6>Banking Details:</h6>
                            <p class="mb-1"><strong>Bank:</strong> FNB</p>
                            <p class="mb-1"><strong>Account Type:</strong> Cheque</p>
                            <p class="mb-1"><strong>Account Number:</strong> 62805281920</p>
                            <p class="mb-0"><strong>Branch:</strong> Woodlands</p>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="total-section p-3">
                        <div class="d-flex justify-content-between mb-2"><span>Sub-total:</span><span>R17,300.00</span></div>
                        <div class="d-flex justify-content-between mb-2"><span>VAT:</span><span>R1,470.50</span></div>
                        <hr style="border-color: var(--ai-primary);">
                        <div class="d-flex justify-content-between"><span><strong>Total:</strong></span><span class="total-amount">R18,770.50</span></div>
                      </div>
                    </div>
                  </div>
                  <div class="row mt-4"><div class="col-12"><div class="text-center"><p class="mb-2" style="color: var(--light-gray);"><strong>Thank you for choosing Virtual Life!</strong></p><p class="mb-0" style="color: var(--neon-blue); font-family: 'Share Tech Mono', monospace;">Dream It. Build It. Launch It.</p></div></div></div>
                </div>
              </div>
            </body>
            </html>
            `;

            const formatDate = (dateString) => new Date(dateString).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });

            const servicesHTML = data.services.map(service => `
                <tr>
                    <td>${formatDate(data.invoice.periodStart)} ‚Äì ${formatDate(data.invoice.periodEnd)}</td>
                    <td class="text-center">${service.quantity.toFixed(2)}</td>
                    <td><b>${service.description}</b>${service.details ? `<br><small style="color: #555;">${service.details.replace(/\n/g, '<br>')}</small>` : ''}</td>
                    <td class="text-center">R ${service.rate.toFixed(2)}</td>
                    <td class="text-end">R ${service.amount.toFixed(2)}</td>
                </tr>`).join('');

            // Replace placeholders in the template string
            let finalHtml = template
                .replace('<p class="invoice-number mb-0">#VL-2025-001</p>', `<p class="invoice-number mb-0">${data.invoice.number}</p>`)
                .replace('[COMPANY_NAME]', data.company.name)
                .replace('[COMPANY_ADDRESS]', data.company.address.replace(/\n/g, '<br>'))
                .replace('[COMPANY_REG]', data.company.reg)
                .replace('[COMPANY_WEBSITE]', data.company.website)
                .replace('[COMPANY_EMAIL]', data.company.email)
                .replace('[COMPANY_PHONE]', data.company.phone)
                .replace('[CLIENT_COMPANY]', data.client.company)
                .replace('[CLIENT_NAME]', data.client.name || '')
                .replace('[CLIENT_ADDRESS]', data.client.address.replace(/\n/g, '<br>'))
                .replace('[CLIENT_VAT]', data.client.vatNumber || 'N/A')
                .replace('[CLIENT_REG]', data.client.regNumber || 'N/A')
                .replace('[CLIENT_EMAIL]', data.client.email || 'N/A')
                .replace('[CLIENT_PHONE]', data.client.phone || 'N/A')
                .replace('[INVOICE_DATE]', formatDate(data.invoice.date))
                .replace('[DUE_DATE]', formatDate(data.invoice.dueDate))
                .replace('[PERIOD_START]', formatDate(data.invoice.periodStart))
                .replace('[PERIOD_END]', formatDate(data.invoice.periodEnd))
                .replace('<tbody><!-- Services will be inserted here by JavaScript --></tbody>', `<tbody>${servicesHTML}</tbody>`)
                .replace('<span>R17,300.00</span>', `<span>R ${data.totals.subtotal.toFixed(2)}</span>`)
                .replace('<span>R1,470.50</span>', `<span>R ${data.totals.tax.toFixed(2)}</span>`)
                .replace('<span class="total-amount">R18,770.50</span>', `<span class="total-amount">R ${data.totals.total.toFixed(2)}</span>`);

            // Remove empty lines for optional client fields
            if (!data.client.name) finalHtml = finalHtml.replace(/<p>\[CLIENT_NAME\]<\/p>/, '');
            if (!data.client.email || data.client.email === 'N/A') finalHtml = finalHtml.replace(/<p>Email: N\/A<\/p>/, '');
            if (!data.client.phone || data.client.phone === 'N/A') finalHtml = finalHtml.replace(/<p>Phone: N\/A<\/p>/, '');

            // Set the content for the modal preview and for the PDF generation
            document.getElementById('invoicePreviewContent').innerHTML = finalHtml;
            window.currentInvoiceHTML = finalHtml;
            new bootstrap.Modal(document.getElementById('invoicePreviewModal')).show();
        }

        async function generatePDF() {
            if (!window.currentInvoiceHTML) {
                alert('Please preview the invoice first.');
                return;
            }

            const loader = document.getElementById('pdf-loader');
            loader.style.display = 'flex';

            const iframe = document.createElement('iframe');
            try {
                iframe.style.position = 'absolute';
                iframe.style.left = '-9999px';
                iframe.style.width = '210mm'; // A4 width
                document.body.appendChild(iframe);

                iframe.contentDocument.open();
                iframe.contentDocument.write(window.currentInvoiceHTML);
                iframe.contentDocument.close();

                // Force full-width, no side margins inside the iframe for capture
                const noMarginStyle = iframe.contentDocument.createElement('style');
                noMarginStyle.textContent = `
                  html, body { margin: 0 !important; padding: 0 !important; }
                  /* Remove Bootstrap container padding and max-width for PDF capture */
                  .container { max-width: 100% !important; padding-left: 0 !important; padding-right: 0 !important; padding-top: 0 !important; padding-bottom: 0 !important; }
                  /* Ensure the invoice fills the available width */
                  .invoice-container { margin: 0 !important; width: 100% !important; border-radius: 0 !important; }
                `;
                (iframe.contentDocument.head || iframe.contentDocument.body).appendChild(noMarginStyle);

                await new Promise(resolve => {
                    iframe.onload = async () => {
                        await iframe.contentWindow.document.fonts.ready;
                        setTimeout(resolve, 300); // Extra delay for rendering
                    };
                });

                const invoiceElement = iframe.contentDocument.querySelector('.invoice-container');
                const canvas = await html2canvas(invoiceElement, {
                    scale: 2,
                    useCORS: true,
                    backgroundColor: null,
                });

                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');

                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();

                const imgData = canvas.toDataURL('image/png');
                const imgWidth = canvas.width;
                const imgHeight = canvas.height;

                const ratio = imgHeight / imgWidth;
                const totalPDFHeight = pdfWidth * ratio;

                let heightLeft = totalPDFHeight;
                let position = 0;

                pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, totalPDFHeight);
                heightLeft -= pdfHeight;

                while (heightLeft > 0) {
                    position -= pdfHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, totalPDFHeight);
                    heightLeft -= pdfHeight;
                }

                const invoiceNumber = document.getElementById('invoiceNumber').value || 'invoice';
                pdf.save(`${invoiceNumber}.pdf`);

            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('An error occurred while generating the PDF. Please try again or use the "Print to PDF" option.');
            } finally {
                loader.style.display = 'none';
                document.body.removeChild(iframe);
            }
        }

        function generatePDFPrint() {
            if (!window.currentInvoiceHTML) return alert('Please preview the invoice first.');
            const printWindow = window.open('', '_blank');
            printWindow.document.write(window.currentInvoiceHTML);
            printWindow.document.close();
            printWindow.onload = function () {
                // Inject print-specific styles to remove side margins and fill width
                try {
                    const style = printWindow.document.createElement('style');
                    style.textContent = `
                      @page { size: A4; margin: 0 !important; }
                      html, body { margin: 0 !important; padding: 0 !important; }
                      .container { max-width: 100% !important; padding-left: 0 !important; padding-right: 0 !important; padding-top: 0 !important; padding-bottom: 0 !important; }
                      .invoice-container { margin: 0 !important; width: 100% !important; border-radius: 0 !important; }
                    `;
                    (printWindow.document.head || printWindow.document.body).appendChild(style);
                } catch (e) { /* noop */ }
                printWindow.print();
                // Some browsers might close the window before the print dialog is shown
                // setTimeout(() => { printWindow.close(); }, 500);
            };
        }
    </script>
</body>

</html>
